kind: pipeline
type: docker
name: web-portfolio-v1

clone:
  disable: true

server:
  host:
    from_secret: vps_ip
  user:
    from_secret: username
  # Set the port manually because it can't be retrieved from a secret â€” the secret returns a string, but the port must be a number.
  # Default SSH Port is 22
  port: 22
  ssh_key:
   from_secret: ssh_private_key
  

steps:
  - name: Checkout
    commands:
      - echo "=== Checkout branch ==="
      - cd ~/projects/web-portfolio-v1
      - git checkout master
  - name: Pulling
    commands:
      - echo "=== Pulling latest code ==="
      - git pull origin 
  - name: Build and Deploy
    commands:
      - echo "=== Building Application ==="
      - echo "=== Stop and Remove the service ==="
      - docker-compose down
      - echo "=== Build and Deploy"
      - docker-compose up -d --build
  - name: Cleanup
    commands:
      - echo "=== Cleanup the service ==="
      - docker system prune -f

trigger:
  event:
    - push
  branch:
    - master